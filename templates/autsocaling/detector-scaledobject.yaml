{{- if and .Values.autoscaling.detector.enabled (or .Values.autoscaling.rmq.enabled .Values.autoscaling.cron.enabled) }}
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ .Values.detector.name | quote }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Values.detector.name | quote }}
  minReplicaCount: {{ .Values.autoscaling.detector.minReplicas }}
  maxReplicaCount: {{ .Values.autoscaling.detector.maxReplicas }}
  triggers:
  {{- if .Values.autoscaling.rmq.enabled }}
  - type: "rabbitmq"
    metadata:
      queueName: "rpc\\.face\\.detect.*"
      mode: "MessageRate"
      value: {{ .Values.autoscaling.detector.rmqRps | quote }}
      useRegex: "true"
    authenticationRef:
      name: {{ .Values.autoscaling.rmq.triggerAuthName | quote }}
  {{- end }}
  {{- if .Values.autoscaling.cron.enabled }}
#   during work hours
  - type: "cron"
    metadata:
      timezone: {{ .Values.autoscaling.cron.timezone | quote }}
      start: "0 8 * * 1-5"
      end: "0 17 * * 1-5"
      desiredReplicas: {{ .Values.autoscaling.detector.workHoursReplicas | quote }}
#   outside work hours
  - type: "cron"
    metadata:
      timezone: {{ .Values.autoscaling.cron.timezone | quote }}
      start: "0 17 * * 1-5"
      end: "0 8 * * 1-5"
      desiredReplicas: {{ .Values.autoscaling.detector.nonWorkHoursReplicas | quote }}
#   during weekend
  - type: "cron"
    metadata:
      timezone: {{ .Values.autoscaling.cron.timezone | quote }}
      start: "0 0 * * 0,6"
      end: "0 0 * * 1-5"
      desiredReplicas: {{ .Values.autoscaling.detector.nonWorkHoursReplicas | quote }}
  {{- end }}
{{- end }}
